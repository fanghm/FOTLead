{% extends "base.html" %}

{% block content %}
  {% if task %}
    <h1 class="text-center">{{task.feature_id}}: {{ task.title }}</h1>
    <form class="container" style="margin-top: 40px;" data-task-id="{{ task.id }}" data-feat-id="{{ task.feature_id }}">
      {% csrf_token %}

      <div class="form-group">
        <label for="title">Task:</label>
        <input class="form-control" type="text" name="title" value="{{task.title}}">
      </div>

      <div class="form-group">
        <label for="owner">Owner:</label>
        <input class="form-control" type="text" name="owner" value="{{task.owner}}">
      </div>

      <div class="form-group">
        <label for="due">Due Date:</label>
        <input class="form-control" type="date" name="due" value="{{ task.due|date:'Y-m-d' }}">
      </div>

      <div class="form-group">
        <label for="contact">Contact:</label>
        <input class="form-control" type="text" name="contact" value="{{task.contact}}">
      </div>

      <div class="form-group">
        <label for="mail">mail:</label>
        <input class="form-control" type="text" name="mail" value="{{task.mail}}">
      </div>

      <div class="form-group">
        <label for="chat">chat:</label>
        <input class="form-control" type="text" name="chat" value="{{task.chat}}">
      </div>

      <div class="form-group">
        <label for="meeting">meeting:</label>
        <input class="form-control" type="text" name="meeting" value="{{task.meeting}}">
      </div>

      <div class="form-group">
        <label for="status">Status:</label>
        <select class="form-control" name="status">
          <option value="Not Started" {% if task.status == "Not Started" %}selected{% endif %}>Not Started</option>
          <option value="Ongoing" {% if task.status == "Ongoing" %}selected{% endif %}>Ongoing</option>
          <option value="On Hold" {% if task.status == "On Hold" %}selected{% endif %}>On Hold</option>
          <option value="Blocked" {% if task.status == "Blocked" %}selected{% endif %}>Blocked</option>
          <option value="Cancelled" {% if task.status == "Cancelled" %}selected{% endif %}>Cancelled</option>
          <option value="Completed" {% if task.status == "Completed" %}selected{% endif %}>Completed</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">Update</button>
      <button type="button" class="btn btn-danger deleteTaskBtn">Delete</button>
    </form>
  {% else %}
    <p>Task not found.</p>
  {% endif %}
{% endblock %}

{% block bottom %}
  <script>
    $(document).ready(function(){
      $("form").on('submit', function(event){
        event.preventDefault();
  
        var taskId = $(this).attr('data-task-id');
        var fid = $(this).attr('data-feat-id');
        var formData = $(this).serialize(); // 获取表单中所有字段的值
  
        $.ajax({
          url: '/ajax_task_update/' + taskId + '/',
          type: 'POST',
          data: formData, // 将所有字段的值发送到后端
          success: function(response){
            alert(response.message);
            url = '/detail/' + fid + '/';
            window.location.href = url;
          }
        });
      });

      $(".deleteTaskBtn").on('click', function(){
        var userConfirmed = confirm("Deleting this task will also removing all its status updates!\nAre you sure you want to continue?");
        if (!userConfirmed) {
          return;
        }

        var taskId = $("form").attr('data-task-id');
        var fid = $("form").attr('data-feat-id');
  
        $.ajax({
          url: '/ajax_task_delete/' + taskId + '/',
          type: 'POST',
          success: function(response){
            alert(response.message);
            url = '/detail/' + fid + '/';
            window.location.href = url;
          }
        });
      });
    });
  </script>
{% endblock %}