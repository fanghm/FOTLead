{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block css %}
  <style>
    .no-wrap {
      white-space: nowrap;
    }
    .progress {
      height: 30px;
    }
    .new_added {
      font-weight: bold;
    }
    .duesoon, .should_start {
      background-color: orange;
    }
    .delayed, .overdue, .not_fitting, .not_committed {
      background-color: red !important;
    }
    .center-align {
      text-align: center;
    }
    .row {
      display: flex;
      align-items: center;
    }
    label, .form-control {
      margin-right: 10px;
    }

    /* override jquery UI tooltip style */
    .ui-tooltip {
      width: 500px;
      background: #f6f6f6;
      border: 2px solid #ccc;
      padding: 3px;
      box-shadow: 0 0 2px rgba(0,0,0,0.1);
      font-size: 15px !important;
    }

    .divider {
      margin: 0 5px 0 5px;
    }

    .tight-table {
        font-size: 12px; /* Smaller font size */
        border-collapse: collapse; /* Remove space between table cells */
        margin-left: 40px;
    }
    .tight-table th, .tight-table td {
        padding: 4px; /* Smaller padding */
        border: 1px solid #ddd; /* Border for table cells */
    }
  </style>
  <link rel="stylesheet" href="{% static 'fotd/jquery-ui.min.css' %}">
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.0/css/dataTables.dataTables.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.0/css/rowGroup.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.css">
{% endblock %}

{% block script %}
  <script src="{% static 'fotd/jquery-ui.min.js' %}"></script>
  <!-- RowGroup requires DataTables 1.11 or newer -->
  <script type="text/javascript" src="{% static 'fotd/dataTables_2.1.0_wa.js' %}" ></script>

  <script src="https://cdn.datatables.net/rowgroup/1.5.0/js/dataTables.rowGroup.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.dataTables.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.colVis.min.js"></script>
{% endblock %}

{% block nav_link %}
<span class="divider">|</span>
<a style="text-align: right;" href="{% url 'fotd:detail' fid %}">{{fid}}</a>
{% endblock %}

{% block content %}
<br>
<h2 style="margin-left: 10px;">{{fid}} Backlog</h2>

<div style="display: flex; align-items: center; margin-left: 10px;">
    {% if query_time %}
      <div>{{ query_time|timesince }} ago</div>
      <span class="divider">|</span>
    {% endif %}

    <a id="refreshLink" href="#">Refresh</a>
    <span class="divider">|</span>

    <label style="margin: 5px 2px; color: blue;">
        <input type="checkbox" id="showDoneItems" {% if query_done %}checked{% endif %}> Show done items
    </label>
    <span class="divider">||</span>

    <a href="https://jiradc.ext.net.nokia.com/secure/StructureBoard.jspa?p=2059383512&s=%7B%22sQuery%22%3A%7B%22query%22%3A%22project%20in%20(FFB)%20%20AND%20%5C%22Feature%20ID%5C%22%20~{{ fid }}%22%2C%22type%22%3A%22jql%22%7D%7D#" target="_blank">Open in JIRA</a>
</div>

{% if not backlog_items %}
  <p style="color: red; margin:0 10px">
    Oops! Feature backlog not found, pls make sure the feature ID &lt;{{fid}}&gt; is correct.<br>
    If the feature is already done, click the above checkbox to show done items.
  </p>
{% else %}

<div class="container-fluid">
  <table id='backlog-table' class="table stripe hover"><!--table-striped stripe -->
    <thead>
      <tr>
        <th rowspan="2"></th>

        {% for field_name in display_fields %}
          <th rowspan="2">{{ field_name|replace:"_, " }}</th>
        {% endfor %}
          <th colspan="{{display_sprints|length}}" data-dt-order="disable">Plan Visualization</th>
      </tr>

      <tr>
        {% for fb in display_sprints %}
          <th data-dt-order="disable"> {{ fb }} </th>
        {% endfor %}
      </tr>
    </thead>

    <tbody>
      {% for item in backlog_items %}
        <tr id="{{item.Key}}" data-id="{{item.ID}}">
          <td class="dt-control"></td>

          {% for field_name, field_value in item.items %}
            {% if field_name not in display_fields %}
              {# dont show #}

            {% elif field_name == "Key" %}
              <td class="no-wrap keyCell">
                <a href="{{link_prefix}}{{field_value}}" target="_blank" title="{{item.Summary}}">{{ field_value }}</a>
                {% if field_value in new_keys %}<img src="{% static 'pix/new.png' %}" alt="New" width="48" height="24" title="New added item">{% endif %}
              </td>

            {% elif field_name == "Progress" %}
              <td class="no-wrap">
                <div class="progress" {% if item.Risk_Status == 'Yellow' or item.Risk_Status == 'Red' %}style="background-color: {{item.Risk_Status|lower}};"
                    title="Risk detail: {% if item.Risk_Details %} {{ item.Risk_Details }} {% else %} Not set {% endif %}" {% endif %}>
                  <div class="progress-bar {% if field_value >= 99.9 %}bg-success{% else %}bg-primary{% endif %}" role="progressbar"
                    style="width: {{ field_value }}%" aria-valuenow="{{ field_value }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
              </td>

            {% elif field_name == "End_FB" %}
              {% if field_value %}
              <td class="no-wrap {{item.tags}}" {% if item.hints %} title="{{ item.hints|safe }}" data-tooltip="{{ item.hints|safe }}" {% endif %}>
                {{ field_value }}
                {% if item.Key in changed_items %} <span style="font-size: x-small;">({{ changed_items|get_previous_end_fb:item.Key }})</span> {% endif %}
              {% else %}
              <td class="no-wrap" style="font-size: 0.7em;">(Not Set)
                {% if item.Assignee %}
                <select class="selectForEndFb" data-item_key="{{ item.Key }}" data-fid="{{ fid }}" data-area="{{item.Competence_Area}}" style="width: 110px;">
                  <option value="">Action...</option>
                  <option value="requestPlanning" data-apo="{{item.Assignee}}" data-apo_email="{{item.Assignee_Email}}">Send planning request</option>
                  <option value="addTask">Add a task to track </option>
                </select>
                {% endif %}
              {% endif %}
              </td>

            {% elif field_name == "RC_Status" %}
              <td class="no-wrap rcStatusCell" style="font-size: 0.7em;">
              {% if field_value %}
                {{ field_value }}
              {% else %}
                (Not Set)
                {% if item.Assignee and item.End_FB %}
                <select class="selectForRcStatus" data-item_key="{{ item.Key }}" data-fid="{{ fid }}"  data-area="{{item.Competence_Area}}" style="width: 110px;">
                  <option value="">Action...</option>
                  <option value="requestRfC" data-apo="{{item.Assignee}}" data-apo_email="{{item.Assignee_Email}}" >Send RfC request for this item</option>
                  <option value="requestRfCAll" data-apo="{{item.Assignee}}" data-apo_email="{{item.Assignee_Email}}" >Send RfC request for the APO's items</option>
                  <option value="addTask" >Add a task to track </option>
                </select>
                {% endif %}
              {% endif %}
              </td>

            {% elif field_name == "RC_FB" %}
              {% if field_value and item.End_FB %}
                <td class="no-wrap {% if item.End_FB > field_value %} delayed {% endif %}">{{ field_value }}</td>
              {% else %}
                <td class="no-wrap">{% if field_value %}{{ field_value }}{% endif %}</td>
              {% endif %}

            {% elif field_name == "Original_Estimate" or field_name == "Time_Remaining" %}
              <td class="no-wrap">{% if field_value %}{{ field_value|rjust:"6" }}{% endif %}</td>

            {% elif field_name == "Assignee" %}
              <td class="no-wrap assigneeCell">
                {% if not field_value %}
                  <span style="background-color: orange;">(Not Assigned)</span>
                  <!--select class="selectForAssignee" data-item_key="{{ item.Key }}" style="width: 110px;">
                    <option value="">Options...</option>
                    <option value="assignAPO">Assign to L-APO: James Bond</option>
                    <option value="sendMail" data-lapo_email="I_MN_RAN_L2_LAPO_GMS">Mail to: I_MN_RAN_L2_LAPO_GMS</option>
                    <option value="openCampPage" data-url="http://camp.example.com">Open the CAMP page...</option>
                  </select-->
                {% else %}
                  {{ field_value|linkify }}
                  <span class="hidden-assignee-for-copy" style="display:none;">{{ field_value }}</span>
                {% endif %}
              </td>

            {% else %}
              <td class="no-wrap">{% if field_value %}{{ field_value|safe }}{% endif %}</td>
            {% endif %}
          {% endfor %}

          {% for fb in display_sprints %}
            {% if fb >= item.Start_FB and fb <= item.End_FB %}
              {% if not_fitting_items and item.Key in not_fitting_items and fb > not_fitting_items|keyvalue:item.Key %}
                <td style="background-color: red;"></td>
              {% else %}
                <td style="background-color: limegreen;"></td>
              {% endif %}
            {% else %}
              <td></td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if boundary %}
  <br><h5>Applicable Program Boundary:</h5>
  <table id="boundaryTable" class="table-bordered center-align">
    <thead>
      <tr>
        <th>Release</th>
        <th>Category</th>
        <th>SW Done</th>
        <th>ET EC</th>
        <th>ET FER</th>
        <th>ET Done</th>
        <th>ST EC</th>
        <th>ST FER</th>
        <th>ST Done</th>
        <th>PET/Five EC</th>
        <th>PET/Five FER</th>
        <th>PET/Five Done</th>
        <th>TA</th>
        <th>CuDo</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>{{ boundary.release }}</td>
          <td>{{ boundary.category }}</td>
          <td>{{ boundary.sw_done }}</td>
          <td>{{ boundary.et_ec }}</td>
          <td>{{ boundary.et_fer }}</td>
          <td>{{ boundary.et_done }}</td>
          <td>{{ boundary.st_ec }}</td>
          <td>{{ boundary.st_fer }}</td>
          <td>{{ boundary.st_done }}</td>
          <td>{{ boundary.pet_five_ec }}</td>
          <td>{{ boundary.pet_five_fer }}</td>
          <td>{{ boundary.pet_five_done }}</td>
          <td>{{ boundary.ta }}</td>
          <td>{{ boundary.cudo }}</td>
        </tr>
    </tbody>
  </table>
  {% endif %}
</div>
{% endif %}

<script>
var LinkCache = JSON.parse("{{ item_links|escapejs }}");
if (LinkCache === null) {
    // console.log('No link data in db, initialize an empty object.');
    LinkCache = {};
}

function updateDatabaseViaAJAX() {
  if(LinkCache['dirty']) {
    LinkCache['dirty'] = false; // reset the dirty flag to avoid multiple updates
    var fid = "{{ fid }}";

    console.log('Updating database via AJAX: ', fid);
    $.ajax({
        type: "POST",
        url: `/ajax_update_item_links/${fid}/`,
        data: JSON.stringify(LinkCache),
        contentType: "application/json",
        success: function(response) {
            console.log("Links updated successfully:", response);
        },
        error: function(error) {
            console.error("Error updating links to db:", error);
            LinkCache['dirty'] = true; // set the dirty flag back to true
        }
    });
  }
}

window.addEventListener('beforeunload', function(event) {
    // 执行一些清理操作
    console.log('beforeunload event triggered');
    //console.log(JSON.stringify(LinkCache));
    updateDatabaseViaAJAX();
});

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log('Tab is hidden');
        //console.log(JSON.stringify(LinkCache));
        updateDatabaseViaAJAX();
    } else {
        //console.log('Tab is visible');
    }
});

$(document).ready(function() {
  var urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('query_done')) {
      $('#showDoneItems').prop('checked', (urlParams.get('query_done') === 'true'));
  }

  $('#showDoneItems').change(function() {
    var queryDoneUrl = new URL(window.location.href);
      queryDoneUrl.searchParams.set('query_done', this.checked ? 'true' : 'false');
      window.location.href = queryDoneUrl.toString();
  });

  function updateQueryUrls() {
      var currentUrl = new URL(window.location.href);
      var refreshUrl = new URL(currentUrl);
      var queryDoneUrl = new URL(currentUrl);

      refreshUrl.searchParams.set('refresh', '');

      var showDoneItemsChecked = $('#showDoneItems').is(':checked');
      queryDoneUrl.searchParams.set('query_done', showDoneItemsChecked ? 'true' : 'false');

      $('a#refreshLink').attr('href', refreshUrl.toString());
      $('a#queryDoneLink').attr('href', queryDoneUrl.toString());
  }

  updateQueryUrls();

  function _group_by(dt, dataColumn) {
    if(dataColumn === -1) { // no grouping
      if(dt.rowGroup().enabled()) {
        dt.rowGroup().disable().draw();
      }
    } else {
      if(!dt.rowGroup().enabled())
        dt.rowGroup().enable().draw();

      dt.rowGroup().dataSrc(dataColumn);
    }
  }

  // for export
  var exportFormatter = {
    format: {
        body: function (data, row, column, node) {
          var strippedData = data.replace(/<[^>]+>/g, '');
          //console.log(`row ${row} col ${col}: ${strippedData}`);
          if(strippedData.toLowerCase().includes('(not set)')) {
            return "(Not Set)";
          } else {
            return strippedData;
          }
        }
    }
  };

  // Get the number of columns
  // -1 because of the colspan th is not a real column
  var numColumns = $('#backlog-table thead th').length - 1;

  // Generate an array of column indexes from 10 to the last column
  var nonSortableColumns = Array.from({length: numColumns - 11}, (_, i) => i + 11);
  //console.log('Number of columns:', numColumns);
  //console.log('Non-sortable columns:', nonSortableColumns);

  // add <tfoot> tag with same number of <th></th> as the table columns
  var tfoot = '<tfoot>';
  for (var i=0; i<numColumns; i++)
    tfoot += '<th></th>';

  tfoot += '</tfoot>';
  $("#backlog-table").append(tfoot);

  var table = $('#backlog-table').DataTable({
    ordering: true,
    order: [[6, "asc"], [3, "asc"]],
    responsive: true,
    //orderFixed: [1, 'asc'],
    rowGroup: { enable: false, dataSrc: 11 },
    //"stateSave": true,
    "scrollX": true,
    "sScrollXInner": "100%",  // if scrollX is true without this line, table body and header might not align
    "scrollY": true,
    "pageLength": -1,
    //"lengthChange": false, // dont show "Show xx entries" by default
    "pagingType": "simple", // use simple pagination

    layout: {
        topStart: {
            buttons: [
              'pageLength',
              {
                extend: 'spacer',
                style: 'bar'
              },
              {
                extend: 'collection',
                autoClose: true,
                text: 'Group by',
                buttons: [
                    {
                        text: 'System Item',
                        action: function (e, dt, node, config) {
                          _group_by(dt, 11);
                        }
                    },
                    {
                        text: 'Entity Item',
                        action: function (e, dt, node, config) {
                          _group_by(dt, 12);
                        }
                    },
                    {
                        text: 'Activity Type',
                        action: function (e, dt, node, config) {
                          _group_by(dt, 3);
                        }
                    },
                    {
                        text: 'Competence Area',
                        action: function (e, dt, node, config) {
                          _group_by(dt, 2);
                        }
                    },
                    {
                        text: 'None',
                        action: function (e, dt, node, config) {
                          _group_by(dt, -1);
                        }
                    }
                ]
              },
              {
                  extend: 'collection',
                  autoClose: true,
                  text: 'Output',
                  buttons: [
                      'copy', // TODO: hide footer
                      {
                          extend: 'excelHtml5',
                          filename: '{{fid}}_backlog_{{ date|date:"Ymd" }}',
                          footer: false,
                      },
                      {
                          extend: 'pdfHtml5',
                          title: 'Backlog of {{fid}}',
                          messageBottom: function() {
                              return '(Exported at ' + new Date().toLocaleString() + ')';
                          },
                          orientation: 'landscape',
                          footer: false,
                          download: 'open',
                          exportOptions: {
                              columns: ':visible',
                              format: {
                                body: function (data, row, column, node) {
                                  //console.log(`row ${row} col ${col}: ${data}`);
                                  return data.toLowerCase().includes('(not set)') ? '(Not Set)' : data.replace(/<[^>]+>/g, '');
                                },
                              },
                          }
                      },
                  ]
              },
              {
                text: 'Table control',
                extend: 'collection',
                autoClose: true,
                buttons: [
                    // {
                    //     text: 'Toggle 1-2',
                    //     action: function ( e, dt, node, config ) {
                    //         dt.column( 1 ).visible( ! dt.column( 1 ).visible() );
                    //         dt.column( 2 ).visible( ! dt.column( 2 ).visible() );
                    //         this.active(!this.active());
                    //     }
                    // },
                    {
                        text: 'Classic View',
                        action: function ( e, dt, node, config ) {
                          for (col of nonSortableColumns)
                            dt.column(col).visible( !dt.column(col).visible() );

                          dt.column(0).visible( ! dt.column( 0 ).visible() );   // hide child rows
                          dt.column(9).visible( ! dt.column( 9 ).visible() );   // hide RC Status column
                          dt.column(10).visible( ! dt.column( 10 ).visible() ); // hide progress column
                          dt.column(11).visible(false); // hide sub-feature column
                          dt.column(12).visible(false); // hide EI column
                          dt.column(13).visible( ! dt.column( 13 ).visible() ); // hide ReP column
                          this.active(!this.active());
                        }
                    },
                    {
                        popoverTitle: 'Visibility control',
                        extend: 'colvis',
                        collectionLayout: 'two-column',
                        exclude: [1, 11],
                    }
                ]
            },
            ]
        }
    },

    "columnDefs": [
      {
        targets: [11, 12, 13],  // hide the SI/EI/Rep columns
        visible: false
      },

      // make the fb columns not sortable
      //{ "orderable": false, "targets": nonSortableColumns },

      // center the start/end fb and totol/remaining effort columns
      // TODO: not working somehow
      {
        "targets": [5,6,7,8],
        "className": "center-align"
      },
    ],

    // "drawCallback": function(settings) {
    //   var api = this.api();
    //   if (api.page.info().pages <= 1) {
    //     $('#' + api.table().node().id + '_paginate').hide(); // hide pagination if only one page
    //   } else {
    //     $('#' + api.table().node().id + '_paginate').show();
    //   }
    //   if (api.page.info().recordsTotal < 20) {
    //     $('#' + api.table().node().id + '_length').hide(); // if record number less than 20, hide "Showing xx entries" dropdown
    //   } else {
    //     $('#' + api.table().node().id + '_length').show();
    //   }
    // },

    // footer
    "footerCallback": function (row, data, start, end, display) {
      let api = this.api();
      let intVal = function (i) {
        return typeof i === 'string'
          ? i.replace(/[\$,\s]/g, '') * 1
          : typeof i === 'number'
          ? i
          : 0;
      };

      // Total over all pages
      total_effort = api.column(7).data().reduce((a, b) => intVal(a) + intVal(b), 0);
      total_remaining = api.column(8).data().reduce((a, b) => intVal(a) + intVal(b), 0);

      // count the number of unique Competence Areas
      let caValues = api.column(2).data().toArray();
      let uniqueCaValues = new Set(caValues);
      let uniqueCaCount = uniqueCaValues.size;

      // Calculate the percentage of rows with "Ready for Commitment" in the RC_Status column
      let totalRows = api.column(9).data().length;
      let rfcCount = api.column(9).data().filter(text => text === "Ready for Commitment").length;
      let rfcOrCommittedCount = api.column(9).data().filter(text => text === "Ready for Commitment" || text.startsWith("Committed")).length;
      let rfcPercentage = (rfcOrCommittedCount / totalRows * 100).toFixed(0);
      let donePercentage = ((total_effort - total_remaining) / total_effort * 100).toFixed(1);

      // Update footer
      api.column(2).footer().innerHTML = `${uniqueCaCount} Areas`;
      api.column(4).footer().innerHTML = '<button id="copyToClipboard">Copy All Names</button>';
      api.column(7).footer().innerHTML = `${total_effort} Hrs`;
      api.column(8).footer().innerHTML = `${total_remaining} Hrs`;
      api.column(9).footer().innerHTML = `${rfcPercentage}% ` + (rfcCount > 0 ? 'RfC' : 'Committed');
      api.column(10).footer().innerHTML = `${donePercentage}% Done`;
    },

  });

  // row grouping: change the fixed ordering when the data source is updated
  table.on('rowgroup-datasrc', function (e, dt, val) {
      table.order.fixed({ pre: [[val, 'asc']] }).draw();
  });

  // row group
  //table._group_by(dt, 10);

  // Use event delegation to catch the click event on the dynamically added button
  $('body').on('click', '#copyToClipboard', function() {
    var columnData = table.column(4).nodes().to$()
        .find('.hidden-assignee-for-copy')
        .map(function() {
            return $(this).text();
        }).get();

    var filteredData = columnData.filter(function(value) {
      return value.trim() !== "";
    });

    var uniqueData = [...new Set(filteredData)];
    var joinedData = uniqueData.join(';');

    navigator.clipboard.writeText(joinedData).then(function() {
      alert('All names copied to your clipboard!');
    }, function(err) {
      console.error('Could not copy text: ', err);
    });
  });

  function escapeHtml(text) {
    if (!text) return text;
    return text.replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
  }

  // Formatting function for row details - modify as you need
  function format(linkData) {
          var links = linkData["links"];
          var rep = linkData["rep"];
          var link_prefix = "https://jiradc.ext.net.nokia.com/browse/";

          // if links is empty, return directly
          if (links.length === 0) {
              return '<ul><li>Child item not yet created, or all of them are done already. <a id="refreshLinks" href="#">Refresh</a></li></ul>';
          }

          var link_details = links.map(link => {
              // Calculate Total_Effort
              var total_effort = (link.Logged_Effort || 0) + (link.Time_Remaining || 0);

              // Change Status to "Delayed" if End_FB > RC_FB
              var status = link.End_FB > link.RC_FB ? "Delayed" : link.Status;

              // Concatenate the last four fields into a "Comment" column
              var comment = [link.Team, link.Risk_Status, link.FB_Committed_Status, link.TC_Number]
                  .filter(field => field && field.trim() !== "")
                  .join(", ");

              return `<tr>
                          <td>${link.Relationship}</td>
                          <td>${link.Item_Type}</td>
                          <td><a href="${link_prefix}${link.Key}" title="${escapeHtml(link.Summary)}" target="_blank">${link.Key}</a></td>
                          <td>${status}</td>
                          <td>${link.Assignee}</td>
                          <td>${link.Start_FB}</td>
                          <td>${link.End_FB}</td>
                          <td>${total_effort}</td>
                         <td>${link.Time_Remaining !== undefined ? link.Time_Remaining : ''}</td>
                          <td>${comment}</td>
                      </tr>`;
          });

          let linkDetailsHtml = link_details.join('');
          if (rep) {
              linkDetailsHtml += `<tr>
                                    <td></td>
                                    <td>ReP</td>
                                    <td colspan="8"><a href="${rep}"" target="_blank">Test Report</a></td>
                                  </tr>`;
          }

          return `<table class="tight-table">
                      <thead>
                          <tr>
                              <th></th>
                              <th>Type</th>
                              <th>Key</th>
                              <th>Status</th>
                              <th>Assignee</th>
                              <th>Start FB</th>
                              <th>End FB</th>
                              <th>Total Effort</th>
                              <th>Time Remaining</th>
                              <th>Comment</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${linkDetailsHtml}
                      </tbody>
                  </table>`;

  }

  // Variable to keep track of the currently opened row
  var currentlyOpenedRow = null;

  // Add event listener for opening and closing details
  $('#backlog-table').on('click', 'td.dt-control', function (e) {
      let tr = $(e.target).closest('tr'); // conver tr to a jQuery object
      let id = tr.data('id');
      let key = tr.attr('id');
      let row = table.row(tr);

      if (row.child.isShown()) {
          // This row is already open - close it
          row.child.hide();
          currentlyOpenedRow = null;
      } else {
          // Close the previously opened row if it exists
          if (currentlyOpenedRow && currentlyOpenedRow.child.isShown()) {
              currentlyOpenedRow.child.hide();
          }

          // set the cursor to wait and disable all click events in the table
          $('body').css('cursor', 'wait');
          $('#backlog-table').css('pointer-events', 'none');

          // Check if details are already cached
          if (key in LinkCache && 'links' in LinkCache[key] && LinkCache[key].links.length > 0) {
            console.log('Use cached link details for ' + key);
            row.child(format(LinkCache[key])).show();
            currentlyOpenedRow = row;

            // restore the cursor and enable table click events
            $('body').css('cursor', 'default');
            $('#backlog-table').css('pointer-events', 'auto');
          } else {
            console.log('Request link details via AJAX for ' + key);
            $.ajax({
                url: `/ajax_get_item_links/${id}/`,
                method: 'GET',
                success: function(linkData) {
                    row.child(format(linkData)).show();
                    currentlyOpenedRow = row;

                    // Cache the details
                    LinkCache[key] = linkData;
                    LinkCache['dirty'] = true;
                },
                error: function() {
                    alert('Failed to load details');
                },
                complete: function() {
                    // restore the cursor and enable table click events
                    $('body').css('cursor', 'default');
                    $('#backlog-table').css('pointer-events', 'auto');
                }
            });
        }
      }
  });

  // use event delegation to catch the click event on the dynamically added link
  $(document).on('click', '#refreshLinks', function(event) {
      console.log('Refresh link details');
      event.preventDefault();

      // get current open row's id
      let id = currentlyOpenedRow.data('id');
      let key = currentlyOpenedRow.data().ID;
      console.log('Refresh link details for ' + key);

      $.ajax({
          type: "GET",
          url: "/ajax_get_all_links/${id}/",
                method: 'GET',
                success: function(linkData) {
                    // replace the current child row with the updated one
                    currentlyOpenedRow.child(format(linkData)).show();

                    // Cache the details
                    LinkCache[key] = linkData;
                    LinkCache['dirty'] = true;
                },
                error: function() {
                    alert('Failed to load details');
                },
                complete: function() {
                    // restore the cursor and enable table click events
                    $('body').css('cursor', 'default');
                    $('#backlog-table').css('pointer-events', 'auto');
                }
      });
  });

  const REQ_TYPE_PLANNING = "Planning";
  const REQ_TYPE_RFC = "RfC";
  function _send_mail_req(req_type, fid, area, item_keys, first_name, apo_email) {
    context = {
      'fid': fid,
      'area': area,
      'item_keys': item_keys,
      'first_name': first_name,
      'apo_email': apo_email
    };

    $.ajax({
      type: "POST",
      url: "/ajax_send_email/" + req_type + "/",
      data: JSON.stringify(context),
      contentType: "application/json",
      success: function(response) {
        console.log("Mail sent successfully:", response);
        alert(req_type + " mail sent successfully!");
      },
      error: function(error) {
        console.error("Error sending email:", error);
        alert("Failed to send email.");
      }
    });
  }

  $('.selectForEndFb').change(function() {
    var fid = $(this).data('fid');
    var area = $(this).data('area');
    var selectedOption = $(this).find('option:selected');

    var apo_email = selectedOption.data('apo_email');
    var apo = selectedOption.data('apo');
    var first_name = apo.split(' ')[0];

    var selectedValue = $(this).val();
    switch (selectedValue) {
      case 'requestPlanning':
        var item_key = $(this).data('item_key');
        console.log('Send a mail to Assignee/APO for planning of ', item_key);
        _send_mail_req(REQ_TYPE_PLANNING, fid, area, [item_key], first_name, apo_email);
        break;

    default:
      alert("Pls select an option.");
    }
  });

  $('.selectForRcStatus').change(function() {
    var fid = $(this).data('fid');
    var area = $(this).data('area');
    var selectedOption = $(this).find('option:selected');

    var apo_email = selectedOption.data('apo_email');
    var apo = selectedOption.data('apo');
    var first_name = apo.split(' ')[0];

    var selectedValue = $(this).val();
    switch (selectedValue) {
      case 'requestRfC':
        var item_key = $(this).data('item_key');
        console.log('Send a mail to Assignee/APO for RfC of ', item_key);
        _send_mail_req(REQ_TYPE_RFC, fid, area, [item_key], first_name, apo_email);
        break;

    case 'requestRfCAll':
      // iterate thru all items on the table and find out all the Keys with same Assignee and RC_Status is not set
      var keysWithSameAssigneeAndUnsetRCStatus = [];
      $('#backlog-table tr').each(function() {
        var row = $(this);
        var assignee = row.find('.assigneeCell').text();
        var rcStatus = row.find('.rcStatusCell').text();
        var key = row.find('.keyCell a').text();

        // 检查分配者电子邮件是否匹配且 RC_Status 未设置
        if (assignee.includes(apo) && rcStatus.includes('(Not Set)')) {
          keysWithSameAssigneeAndUnsetRCStatus.push(key);
        }
      });

      _send_mail_req(REQ_TYPE_RFC, fid, area, keysWithSameAssigneeAndUnsetRCStatus, first_name, apo_email);
      //console.log(keysWithSameAssigneeAndUnsetRCStatus);
      //alert("found keys: " + keysWithSameAssigneeAndUnsetRCStatus.length);
      break;

    default:
      alert("Pls select an option.");
    }
  });

  $('.selectForAssignee').change(function() {
    var selectedOption = $(this).find('option:selected');
    var selectedValue = $(this).val();
    var item_key = $(this).data('item_key');
    var lapo_email = selectedOption.data('lapo_email');

    switch (selectedValue) {
      case 'assignAPO':
        console.log('Update APO directly in JIRA', item_key);
        //refresh the page after that
        //break;
      case 'sendMail':
        console.log('Send a mail to L-APO for ', item_key);
        //break;

      default:
        console.log('Not implented yet.');
        alert("Not implented yet.");
    }
  });
});

$('#boundaryTable').DataTable({
  "paging": false,
  "ordering": false,
  "searching": false,
  "info": false
});
</script>
{% endblock %}
